# Nuages PubSub Starter

Nuages.PubSub is a WebSocket services based on API Gateway WebSocket. It provides all the building block to easily deploy the backend to Lambda using Cloud Formation.

This repository is for deployment only. Full source code available here https://github.com/nuages-io/nuages-pubsub

### At a glance:

- Similar to Azure Web PubSub
- Include WebSocket Service + Client API
- .NET Core 6 SDK included
- Open API endpoint available (/swagger)
- Many database options are available: DynamoDb, MongoDb and MySql. More can be added by providing additional provider trough DI.
- Use the following AWS services
  - API Gateway
  - Lambda
  - CloudFront (CDK)
  - IAM
  - CloudWatch
  - Route 53 for custom domain (optional)
  - Certificate Manager (optional)
  - System Manager (parameter store, optional)
  - DynamoDb (optional)

## Getting Started

Everything is ready to be used as-is. All you need to do is deploy using the CDK from you machine. (Deployment using CDK Pipeline is currently not supported as it is not yet compatible witgh .NET 6)

The easy way:

1. Configure the CDK on your machine https://docs.aws.amazon.com/cdk/v2/guide/work-with.html#work-with-prerequisites
2. git clone https://github.com/nuages-io/nuages-pubsub-starter
3. cdk deploy 


## Customizing the stack

You can customize most of the settings to fit you needs. Just follow the instructions below.


### 1. Clone this Github repository on your machine

```
git clone https://github.com/nuages-io/nuages-pubsub-starter
```
### 2. Setup CDK deployment options

The following context variable can be set to customize the deployment using the CDK. (See https://docs.aws.amazon.com/cdk/v2/guide/context.html for detail about context).

#### Deployment options

By default, the stack will be deployed with the current configuration

- Auto generated URL for WebSocket service and API
- DynamoDb as internal storage

You can customize this behavior by setting the following options.

| Name                       | Description                           | Instructions                             |
|----------------------------|---------------------------------------|------------------------------------------|
| WebSocket_Domain           | WebSocket Endpoint Domain Name        | Optional (Ex. websocket.example.com)    |
| WebSocket_CertificateArn   | Certificate for WebSocket Endpoint    | Required if WebSocket_Domain is assigned |
| API_Domain                 | API Endpoint Domain Name              | Optional (api-websocket.example.ciom)   |
| API_CertificateArn         | Certificate for API Endpoint          | Required if API_Domain is assigned       |
| API_ApiKey                 | API Gateway API Key                   | Will be autogenerated if not provided    |
| Data_Storage               | Database Engine (1)                   | Default to DynamoDb                      |                          
| Data_Port                  | Port used By DbEngine                 | Specify only if different from the default| 

(1) IMPORTANT!!! 

- Supported database are DynamoDb, MongoDb and MySql.
- Only DynamoDb tables will be deployed as part of the stack. For other database engine,s you need to do this deploy on your own and provide the connection string.
- It is recommended to setup a DatabaseProxy for MySql (https://docs.aws.amazon.com/lambda/latest/dg/configuration-database.html)

You can set those values using environment variables, cdk.context.json or using an appsettings.deploy.json files.

#### Sample appsettings.deploy.json

```json
{
  "Env": {
    "PubSub": {
      "Issuer":  "https://issuer.example.com",
      "Audience":  "YourAudience",
      "Secret":  "YourSecret"
    }
  },
  "WebSocket": {
    "Domain": "https://websocket.example.com",
    "CertificateArn": "certificate-arn-valid-for-domain-above"
  },
  "API": {
    "Domain": "https://api-websocket.example.com",
    "CertificateArn": "certificate-arn-valid-for-domain-above",
    "ApiKey": "fc6999a6-84b2-49ed-a458-3c5d5f459034"
  },
  "StackName": "YourStackName",
  "Data": {
      "Storage" : "MongoDb",
      "Port" : 3306,
      "ConnectionString": "connection-string",
      "CreateDynamoDbStorage": false
    }
  
}
```
#### Runtime values set at deployment (optional)

The following application settings can be set at deployment time but can also be set using standard application settings. See the following section for additional options.

| Name                  | Description                           | Instructions                             |
|-----------------------|---------------------------------------|------------------------------------------|
| Data_ConnectionString | Database Server connections string    | Required if not DynamoDb                 |
| Auth_Audience         | JWT Audience                          |                                          |
| Auth_Issuer           | JWT Issuer                            |                                          |
| Auth_Secret           | JWT Secret                            |                                          |


### 3. Setup production runtime values

You have many options here:

- Set options using context variables at deploy time (see previous step 2.)
- Change appsettings.json (not recommended...)
- Add a file called appsettings.prod.json (it will be ignored by git)
- Set options from System Manager Parameter Store (recommended)

The expected configuration format is as followed.

```json
{
  "Nuages": {
    "Data": {
      "Storage" : "MongoDb",
      "ConnectionString": "connection-string"
    },
    "Auth": {
      "Issuer":  "https://issuer.example.com",
      "Audience":  "YourAudience",
      "Secret":  "YourSecret"
    }
  }
}
```

The expected Parameter Store values should have the following key format

{$StackName}/{$Keys}

Ex. For the "Nuages:Data:Storage" settings above, the key would be "{$StackName}/Nuages/Data/Storage"

More info on this can be found here https://github.com/aws/aws-dotnet-extensions-configuration

### 4. Deploy

Run this command at the solution root

```
cdk deploy
```

## External authentication

You may use external token instead of token generated by the API.

```csharp

      //Call UseExternalAuthRoute

      var pubSubBuilder = 
      serviceCollection
          .AddPubSubLambdaRoutes(configuration)
          .UseExternalAuthRoute(options =>
          {
              //Set options here or set application settings
          })
      .AddPubSubService();
```

Sample configuration section.

```json
{
  "Nuages":
  {
    "ExternalAuth" :
    {
      "ValidAudiences" : "YourAudience",
      "ValidIssuers" : "https://issuer.example.com",
      "JsonWebKeySetUrlPath" : ".well-known/jwks.json",
      "DisableSslCheck" : false
    }
  }
}
```

## API / SDK

API Documentaiton is available here https://app.swaggerhub.com/apis-docs/Nuages/NuagesPubSub/1.0.0#/

C# SDK is available here https://www.nuget.org/packages/Nuages.PubSub.API.Sdk/
