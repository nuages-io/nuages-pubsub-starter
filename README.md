# Nuages PubSub Starter

Nuages.PubSub is a WebSocket services based on API Gateway WebSocket. It provides all the building block to easily deploy the backend to Lambda using Cloud Formation.

This repository is for deployment only. Full source code available here https://github.com/nuages-io/nuages-pubsub

### At a glance:

- Similar to Azure Web PubSub
- Include WebSocket Service + Client API
- .NET Core 6 SDK included
- Open API endpoint available (/swagger)
- Many database options are available: DynamoDb, MongoDb and MySql. More can be added by providing additional provider trough DI.
- Use the following AWS services
  - API Gateway
  - Lambda
  - CloudFront (CDK)
  - IAM
  - CloudWatch
  - Route 53 for custom domain (optional)
  - Certificate Manager (optional)
  - System Manager (parameter store, optional)
  - DynamoDb (optional)



## Perequisites

**IMPORTANT!** You need to have CDK configured on your machine

https://docs.aws.amazon.com/cdk/v2/guide/work-with.html#work-with-prerequisites

**IMPORTANT!** You need .NET 6. 

## Getting Started

Everything is ready to be used as-is. All you need to do is deploy using the CDK from you machine. 

**The easy way:**

1. Install the CDK
1. git clone https://github.com/nuages-io/nuages-pubsub-starter
2. (Optional but recommended) Change AuthIssuer, AuthAudience and AuthSecret values in Nuages.PubSub.Starter.Cdk/Program.cs
2. cdk deploy 

That's it. You are ready to go!

**The harder way:**

Some benefits require some work. Follow the steps in the following sections to customize the stack.



## Customizing the deployment stack

You can customize most of the settings to fit you needs. Just follow the instructions below.


### 1. Clone this Github repository on your machine

```
git clone https://github.com/nuages-io/nuages-pubsub-starter
```
### 2. Setup CDK deployment options

The following context variable can be set to customize the deployment using the CDK. (See https://docs.aws.amazon.com/cdk/v2/guide/context.html for detail about context).

#### DEPLOYMENT options

By default, the stack will be deployed with the current configuration

- Auto generated URL for WebSocket Enpoint and API Endpoint
- DynamoDb as internal storage

You can customize this behavior by setting the following options.

| Name                    | Description                        | Instructions                             |
| ----------------------- | ---------------------------------- | ---------------------------------------- |
| WebSocketDomain         | WebSocket Endpoint Domain Name     | Optional (Ex. websocket.example.com)     |
| WebSocketCertificateArn | Certificate for WebSocket Endpoint | Required if WebSocket_Domain is assigned |
| ApiDomain               | API Endpoint Domain Name           | Optional (api-websocket.example.ciom)    |
| ApiCertificateArn       | Certificate for API Endpoint       | Required if API_Domain is assigned       |
| ApiApiKey               | API Gateway API Key                | Will be autogenerated if not provided    |
| DataStorage             | Database Engine (1)                | Default to DynamoDb                      |
| Secu                    |                                    |                                          |

**(1) IMPORTANT!!!** 

- Supported databases are DynamoDb, MongoDb and MySql.
- Only DynamoDb tables will be deployed as part of the stack. For other database engines, you need to do this deploy on your own and provide the connection string.
- It is recommended to setup a DatabaseProxy for MySql (https://docs.aws.amazon.com/lambda/latest/dg/configuration-database.html)



**Database Proxy Options**

You will also have to set the following options if you choose to use a DatabaseProxy. Both the VPC and DatabaseProxy must exists and will not be created during deployment.

| Name                       | Description                | Instructions                                                 |
| -------------------------- | -------------------------- | ------------------------------------------------------------ |
| VpcId                      | Id of the VPC              | Must be the VPC of the dtabase you connect to                |
| DatabaseProxyUser          | Database user name         | Must be the same as in the connection string                 |
| DatabaseProxySecurityGroup | Database Security Group ID | Functions will be added to this security group. The security group must have access to both the proxy and the database. |
| DatabaseProxyArn      | ARN of the Database Proxy |  |
| DatabaseProxyEndpoint | Proxy Endpoint            |  |
| DatabaseProxyName     | Name of the proxy         |  |


#### RUNTIME options set at DEPLOYMENT (optional)

The following application settings can be set at deployment time but can also be set using standard application settings. 

| Name                  | Description                           | Instructions                             |
|-----------------------|---------------------------------------|------------------------------------------|
| DataConnectionString | Database Server connections string    |            |
| AuthAudience         | JWT Audience                          |                                          |
| AuthIssuer           | JWT Issuer                            |                                          |
| AuthSecret           | JWT Secret                            |                                          |



### 3. Setting RUNTIME option at runtime

Runtime option applies to **Nuages.PubSub.Starter.API** and **Nuages.PubSub.Starter.WebSocket** projects.

You have many options to set application settings:

- Change appsettings.json (not recommended)
- Set options from System Manager Parameter Store 
- Set options from System Manager AppConfig


The expected appsettings.json configuration format is as followed.

```json
{
  "Nuages": {
    "Data": {
      "Storage" : "MongoDb",
      "MongoDb" : 
      {
          "ConnectionString": "connection-string"
      },
      "MySql" : 
      {
          "ConnectionString": null
      }      
    },
    "PubSub": {
      "Issuer":  "https://issuer.example.com",
      "Audience":  "YourAudience",
      "Secret":  "YourSecret"
    },
    "ExternalAuth" :
    {
      "ValidAudiences" : null,
      "ValidIssuers" : null,
      "JsonWebKeySetUrlPath" : null,
      "DisableSslCheck" : false
    }
  }
}
```

**You can also use System Manager Parameter Store**

The expected Parameter Store values should have the following key format

*{$StackName}/{$Keys}*

Ex. For the "Nuages:Data:Storage" settings above, the key would be "{$StackName}/Nuages/Data/Storage"

More info on this can be found here https://github.com/aws/aws-dotnet-extensions-configuration

### 4. Deploy

Run this command at the solution root

```
cdk deploy
```

## External authentication

You may want to use external token instead of token generated by the API. 

```csharp
      //Call UseExternalAuthRoute
      var pubSubBuilder = 
      serviceCollection
          .AddPubSubLambdaRoutes(configuration)
          .UseExternalAuthRoute(options =>
          {
              //Set options here or set application settings
            	options.ValidAudiences = "...",
            	options.ValidIssuers = "...",
            	options.JsonWebKeySetUrlPath" : ".well-known/openid-configuration"
              //If you use Auth0
              //options.JsonWebKeySetUrlPath" : ".well-known/jwks.json"  
          })
      .AddPubSubService();
```

Sample configuration section.

```json
{
  "Nuages":
  {
    "ExternalAuth" :
    {
      "ValidAudiences" : "YourAudience",
      "ValidIssuers" : "https://issuer.example.com",
      "JsonWebKeySetUrlPath" : ".well-known/openid-configuration",
      "DisableSslCheck" : false
    }
  }
}
```

## API / SDK

API Documentaiton is available here https://app.swaggerhub.com/apis-docs/Nuages/NuagesPubSub/1.0.0#/

C# SDK is available here https://www.nuget.org/packages/Nuages.PubSub.API.Sdk/
