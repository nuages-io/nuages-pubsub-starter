# Nuages PubSub

Nuages.PubSub is a WebSocket services based on API Gateway WebSocket. It provides all the building block to easily deploy the backend to Lambda using Cloud Formation.

### At a glance:

- Similar to Azure Web PubSub
- Include WebSocket Service + Client API
- .NET Core 6 SDK included
- Open API endpoint available (/swagger)
- Two database options are available, DynamoDb and MongoDb. More can be added by providing additional provider trough DI.
- Use the following AWS services
  - API Gateway
  - Lambda
  - CloudFront (CDK)
  - IAM
  - CloudWatch
  - Route 53 for custom domain (optional)
  - Certificate Manager (optional)
  - System Manager (parameter store, optional)
  - DynamoDb (optional)

## Getting Started

Everything is ready to be used as-is. All you need to do is configure some settings and deploy using the CDK from you machine. (Deployment using CDK Pipeline is currently not supported as it is not yet compatible witgh .NET 6)

Follow those steps to configure and deploy

### 1. Clone this Github repository on your machine

```
git clone https://github.com/nuages-io/nuages-pubsub
```
### 2. Setup CDK deployment options

The following context variable should be set to deploy using the CDK. (See https://docs.aws.amazon.com/cdk/v2/guide/context.html for detail about context).

#### Deployment options

| Name                       | Description                           | Instructions                             |
|----------------------------|---------------------------------------|------------------------------------------|
| WebSocket_Domain           | WebSocket Endpoint Domain Name        | Ex. websocket.mydomain.com               |
| WebSocket_CertificateArn   | Certificate for WebSocket Endpoint    | Required if WebSocket_Domain is assigned |
| API_Domain                 | API Endpoint Domain Name              | Ex. api-websocket.mydomain.ciom          |
| API_CertificateArn         | Certificate for API Endpoint          | Required if API_Domain is assigned       |
| API_ApiKey                 | API Gateway API Key                   | Will be autogenerated if not provided    |
| Data_Storage               | Database  (MongoDb or DynamoDb)       | Default to DynamoDb                      |                          

IMPORTANT!!! MongoDb is not deployed by CDK. You need to do this on your own and provide the connection string and database name.

You can set those values using environment variables, cdk.context.json or using an appsettings.deploy.json files.

#### Sample appsettings.json.json

```json
{
  "Env": {
    "Data": {
      "Storage" : "MongoDb",
      "ConnectionString": "connection-string-for-mongodb",
      "DatabaseName":  "my-database-for-mongodb"
    },
    "PubSub": {
      "Issuer":  "https://issuer.yourdomain.com",
      "Audience":  "YourAudience",
      "Secret":  "YourSecret"
    }
  },
  "WebSocket": {
    "Domain": "https://websocket.yourdomain.com",
    "CertificateArn": "certificate-arn-valid-for-domain-above"
  },
  "API": {
    "Domain": "https://api-websocket.yourdomain.com",
    "CertificateArn": "certificate-arn-valid-for-domain-above",
    "ApiKey": "fc6999a6-84b2-49ed-a458-3c5d5f459034"
  },
  "StackName": "YourStackName",
  "CreateDynamoDbStorage": false
}
```
#### Runtime values set at deployment (optional)

The following application settings can be set at deployment time but can also be set using standard application settings. See the following section for additional options.

| Name                  | Description                           | Instructions                             |
|-----------------------|---------------------------------------|------------------------------------------|
| Data_ConnectionString | Database Server connections string    | Required for MongoDb                     |
| Data_DatabaseName     | Database name                         | Required for MongoDb                     |
| Audience              | JWT Audience                          |                                          |
| Issuer                | JWT Issuer                            |                                          |
| Secret                | JWT Secret                            |                                          |


### 3. Setup production values

You have many options here:

- Set options using context variables at deploy time (see previous step 2.)
- Change appsettings.json (not really recommended...)
- Add a file called appsettings.prod.json (it will be ignored by git)
- Set options from System Manager Parameter Store

The expected config format is as followed.

```json
{
  "Nuages": {
    "Data": {
      "ConnectionString": "connection-string-for-mongodb",
      "DatabaseName":  "my-database-for-mongodb"
    },
    "PubSub": {
      "Issuer":  "https://issuer.yourdomain.com",
      "Audience":  "YourAudience",
      "Secret":  "YourSecret"
    }
  }
}
```


### 4. Deploy

Run this command at the solution root

```
cdk deploy
```

- External auth
- Api / Swagger
- SDK
- Connect
- Send / receive
- Ack
