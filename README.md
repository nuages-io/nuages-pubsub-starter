# Nuages PubSub Starter

Nuages.PubSub is a WebSocket services based on API Gateway WebSocket. It provides all the building block to easily deploy the backend to Lambda using Cloud Formation.

This repository is for deployment only. Full source code available here https://github.com/nuages-io/nuages-pubsub

### At a glance:

- Similar to Azure Web PubSub
- Include WebSocket Service + Client API
- .NET Core 6 SDK included
- Open API endpoint available (/swagger)
- Many database options are available: DynamoDb, MongoDb and MySql. More can be added by providing additional provider trough DI.
- Use the following AWS services
  - API Gateway
  - Lambda
  - CloudFront (CDK)
  - IAM
  - CloudWatch
  - Route 53 for custom domain (optional)
  - Certificate Manager (optional)
  - System Manager (Parameter Store, App Config, optional)
  - DynamoDb (optional)



## Perequisites

**IMPORTANT!** You need to have CDK configured on your machine

https://docs.aws.amazon.com/cdk/v2/guide/work-with.html#work-with-prerequisites

**IMPORTANT!** You need .NET 6. 

## Getting Started

Everything is ready to be used as-is. All you need to do is deploy using the CDK from you machine. 

**The easy way:**

1. Install the CDK
1. git clone https://github.com/nuages-io/nuages-pubsub-starter
2. cdk deploy 

That's it. You are ready to go!

**The harder way:**

Some benefits require some work. Follow the steps in the following sections to customize the stack.



## Customizing the deployment stack

You can customize most of the settings to fit you needs. Just follow the instructions below.


### 1. Clone this Github repository on your machine

```
git clone https://github.com/nuages-io/nuages-pubsub-starter
```
### 2. Setup CDK deployment options

The following context variable can be set to customize the deployment using the CDK. (See https://docs.aws.amazon.com/cdk/v2/guide/context.html for detail about context).

#### DEPLOYMENT options

By default, the stack will be deployed with the current configuration

- Auto generated URL for WebSocket Enpoint and API Endpoint
- DynamoDb as internal storage
- Auto-generated API key
- Default values for Issuer, Audience and Secret.

You can customize this behavior by setting the following options.

| Name                    | Description                        | Instructions                             |
| ----------------------- | ---------------------------------- | ---------------------------------------- |
| WebSocketDomain         | WebSocket Endpoint Domain Name     | Optional (Ex. websocket.example.com)     |
| WebSocketCertificateArn | Certificate for WebSocket Endpoint | Required if WebSocket_Domain is assigned |
| ApiDomain               | API Endpoint Domain Name           | Optional (api-websocket.example.ciom)    |
| ApiCertificateArn       | Certificate for API Endpoint       | Required if API_Domain is assigned       |
| ApiApiKey               | API Gateway API Key                | Will be autogenerated if not provided    |

**(1) IMPORTANT!!!** 

- Supported databases are DynamoDb, MongoDb and MySql.
- Only DynamoDb tables will be deployed as part of the stack. For other database engines, you need to do this deploy on your own and provide the connection string.
- It is recommended to setup a DatabaseProxy for MySql (https://docs.aws.amazon.com/lambda/latest/dg/configuration-database.html)



**Database Proxy Options**

The following options applies if you choose to use a DatabaseProxy for your SQL database. Both the VPC and DatabaseProxy must exists and will NOT be created during deployment. All options are required.

| Name                       | Description                | Instructions                                                 |
| -------------------------- | -------------------------- | ------------------------------------------------------------ |
|                       |               |                 |
| VpcId                   | Id of the VPC.                                      | Must be the VPC of the database you connect to |
| SecurityGroupId         | Security group Id | Must have access to the database and proxy |
| DatabaseProxyUser          | Database user name         | Must be the same as in the connection string                 |
| DatabaseProxyArn      | ARN of the Database Proxy | Required |
| DatabaseProxyEndpoint | Proxy Endpoint            | Required |
| DatabaseProxyName     | Name of the proxy         | Required |



**Other settings**

The following settings can be set at deployment time. You may also want to set the values using standard application settings (see following section).

| Name          | Description    | Instructions |
| ------------- | -------------- | ------------ |
|               |                |              |
| Auth_Issuer   | Token issuer   |              |
| Auth_Audience | Token audience |              |
| Auth_Secret   | Token secret   |              |



The following settings applies when you want to use External Authentification 

| Name                              | Description | Instructions |
| --------------------------------- | ----------- | ------------ |
|                                   |             |              |
| ExternalAuth_Enabled              |             |              |
| ExternalAuth_ValidAudiences       |             |              |
| ExternalAuth_ValidIssuers         |             |              |
| ExternalAuth_DisableSslCheck      |             |              |
| ExternalAuth_JsonWebKeySetUrlPath |             |              |



### 3. Appsettings.json

Runtime option applies to **Nuages.PubSub.Starter.API** and **Nuages.PubSub.Starter.WebSocket** projects.

You have many options to set application settings:

- Change appsettings.json 
- Set directly in the code
- Set options from System Manager Parameter Store 
- Set options from System Manager AppConfig (recommended)


The expected appsettings.json configuration format is as followed.

```json
{
  "Nuages": {
    
    "PubSub": {
      "Auth":
      {
        "Issuer":  "https://issuer.example.com",
        "Audience":  "YourAudience",
        "Secret":  "YourSecret"
      },
      "ExternalAuth" :
      {
        "Enabled" : false,
        "ValidAudiences" : null,
        "ValidIssuers" : null,
        "JsonWebKeySetUrlPath" : null,
        "DisableSslCheck" : false
      },
      "Data": {
        "Storage" : "MongoDb",
        "ConnectionString" : null
    	}
    }    
  }
}
```



**System Manager App Config**

By default, application config will be loaded using the following identifiers. Those values can be changed in appsettings.json.

- ApplicationId : NuagesPubSubStarter
- ConfigProfileId: Shared
- EnvironmentId: Prod

You can create this configuration in App Config using the same identifier and add your application settings file as a hosted configuration.



**System Manager Parameter Store**

By default, parameter store values are loaded from path root /NuagesPubSub. That value can be changed in appsettings.json.

The expected Parameter Store values should have the following key format

*{$StackName}/{$Keys}*

Ex. For the "Nuages:Data:Storage" settings above, the key would be "{$StackName}/Nuages/Data/Storage"

More info on this can be found here https://github.com/aws/aws-dotnet-extensions-configuration

### 4. Deploy

**Deploy locally**

Run this command at the solution root

```
cdk deploy
```

**Continuous integration and delivery (CI/CD)** (using GitHub)

More information available here : https://docs.aws.amazon.com/cdk/v2/guide/cdk_pipeline.html

You can us this method to have the application redeployed when there is a push in your repository. This will only work if you host the source code in your own forked repository.

Add --pipeline to the "app" element in cdk.json. The command should look like

```
"app": "sh build.sh;dotnet run --project src/Nuages.PubSub.Cdk.Starter/Nuages.PubSub.Starter.Cdk.csproj --pipeline"
```

Add CDK configuraration to your application settings

```json
"CDKPipeline": {
    "GitHubRepository": "OWNER/REPO",
    "GithubToken": "{your-github-token}",
  	"NotificationTargetArn" : "~your-notification-arn-chatbot-or-sns"
  }
```

Run this command at the solution root

```
cdk deploy
```

The CDK pileline will be deployed. Then, the pipeline will deploy the stack. 

You can also be notified for pipeline events. Just add a notification target Arn to NotificationTargetArn in the configuration.



## External authentication

You may want to use external token instead of token generated by the API. 

To do so, you will have to call UseExternalAuthRoute and provide some settings.

```csharp
      serviceCollection
        	.AddPubSubService()
          .AddPubSubLambdaRoutes(configuration)
          .UseExternalAuthRoute(options =>
          {
            	options.Enabled = true;
            
              //Set options here or set application settings
            	options.ValidAudiences = "...",
            	options.ValidIssuers = "...",
            	options.JsonWebKeySetUrlPath" : ".well-known/jwks" //With OpenIdDict
              //Identity Server
              // options.JsonWebKeySetUrlPath" : ".well-known/openid-configuration/jwks"
              //If you use Auth0
              //options.JsonWebKeySetUrlPath" : ".well-known/jwks.json"  
              //You can find the Url of your authority by navigating to Url with path .well-known/openid-configuration
              options.DisableSslCheck = false; //May be usefull if using ngrok
          });
      
```

Sample configuration section.

```json
{
  "Nuages":
  {
    "PubSub":
    {
      "ExternalAuth" :
      {
        "Enabled": true,
        "ValidAudiences" : "YourAudience",
        "ValidIssuers" : "https://issuer.example.com",
        "JsonWebKeySetUrlPath" : ".well-known/jwks",
        "DisableSslCheck" : false
      }
    }
  }
}
```

## API / SDK

API Documentaiton is available here https://app.swaggerhub.com/apis-docs/Nuages/NuagesPubSub/1.0.0#/

C# SDK is available here https://www.nuget.org/packages/Nuages.PubSub.API.Sdk/
